name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    name: Release
    runs-on: large
    permissions:
      contents: write
      id-token: write
      attestations: write
      actions: write

    steps:
      - name: Check if prerelease
        id: check-prerelease
        run: |
          if [[ "${{ github.ref_name }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
          else
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
            echo "WARN: This is a prerelease"
          fi

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: Install build dependencies
        run: |
          # Use Ubuntu snapshot to pin packages
          SNAPSHOT_DATE="20250107T000000Z"
          echo "deb [check-valid-until=no] https://snapshot.ubuntu.com/ubuntu/${SNAPSHOT_DATE} noble main restricted universe multiverse" | sudo tee /etc/apt/sources.list
          echo "deb [check-valid-until=no] https://snapshot.ubuntu.com/ubuntu/${SNAPSHOT_DATE} noble-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [check-valid-until=no] https://snapshot.ubuntu.com/ubuntu/${SNAPSHOT_DATE} noble-security main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
    
          sudo apt-get update
          sudo apt-get install -y pipx ubuntu-keyring debian-archive-keyring make jq binutils
          sudo pipx install git+https://github.com/systemd/mkosi.git@54c625c380ef5500f17460981a3c67b109b6a847 #v25.3
          sudo pipx ensurepath
          mkdir -p packages mkosi.extra/usr/local/bin

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5  # v6.2.0
        with:
          go-version: '1.25'

      - name: Build tinfoil-init
        run: |
          cd tinfoil-boot
          go build -ldflags="-s -w" -o ../mkosi.extra/usr/local/bin/tinfoil-init .
          # Log hash for integrity verification
          sha256sum ../mkosi.extra/usr/local/bin/tinfoil-init

      - name: Build image
        run: |
          sudo /opt/pipx_bin/mkosi --image-version ${{ github.ref_name }}

      - name: Fix permissions
        run: |
          mkdir -p /tmp/out
          sudo chmod 644 tinfoilcvm.*
          sudo chown $USER:$USER tinfoilcvm.*

      - name: Generate manifest
        id: manifest
        run: |
          # Generate manifest JSON
          cat > /tmp/out/tinfoil-inference-${{ github.ref_name }}-manifest.json << EOF
          {
            "version": "${{ github.ref_name }}",
            "root": "$(objcopy -O binary --only-section .cmdline tinfoilcvm.efi /dev/stdout | cut -d "=" -f 2)",
            "initrd": "$(sha256sum tinfoilcvm.initrd | awk '{print $1}')",
            "kernel": "$(sha256sum tinfoilcvm.vmlinuz | awk '{print $1}')",
            "raw": "$(sha256sum tinfoilcvm.raw | awk '{print $1}')",
            "built_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          
          # Copy artifacts with versioned names
          cp tinfoilcvm.initrd /tmp/out/tinfoil-inference-${{ github.ref_name }}.initrd
          cp tinfoilcvm.vmlinuz /tmp/out/tinfoil-inference-${{ github.ref_name }}.vmlinuz
          cp tinfoilcvm.raw /tmp/out/tinfoil-inference-${{ github.ref_name }}.raw
          
          # Generate checksums
          cd /tmp/out
          sha256sum * | tee tinfoil-inference-${{ github.ref_name }}-checksums.sha256
          
          echo "digest=sha256:$(sha256sum tinfoil-inference-${{ github.ref_name }}-manifest.json | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Attest artifacts
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a  # v3.0.0
        with:
          subject-path: |
            /tmp/out/tinfoil-inference-${{ github.ref_name }}-manifest.json
            /tmp/out/tinfoil-inference-${{ github.ref_name }}.initrd
            /tmp/out/tinfoil-inference-${{ github.ref_name }}.vmlinuz
            /tmp/out/tinfoil-inference-${{ github.ref_name }}.raw

      - name: Upload artifact
        uses: ryand56/r2-upload-action@b801a390acbdeb034c5e684ff5e1361c06639e7c
        with:
          r2-account-id: ${{ secrets.R2_IMAGES_ACCOUNT_ID }}
          r2-access-key-id: ${{ secrets.R2_IMAGES_ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.R2_IMAGES_SECRET_ACCESS_KEY }}
          r2-bucket: ${{ secrets.R2_IMAGES_BUCKET }}
          source-dir: /tmp/out
          destination-dir: ./cvm

      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PRERELEASE_FLAG=""
          if [ "${{ steps.check-prerelease.outputs.is_prerelease }}" = "true" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi
          
          gh release create "${{ github.ref_name }}" \
            -R ${{ github.repository }} \
            $PRERELEASE_FLAG \
            --title "${{ github.ref_name }}" \
            --notes "### Downloads
          - Kernel: https://images.tinfoil.sh/cvm/tinfoil-inference-${{ github.ref_name }}.vmlinuz
          - Initrd: https://images.tinfoil.sh/cvm/tinfoil-inference-${{ github.ref_name }}.initrd
          - Disk: https://images.tinfoil.sh/cvm/tinfoil-inference-${{ github.ref_name }}.raw

          ### Manifest
          \`\`\`json
          $(cat /tmp/out/tinfoil-inference-${{ github.ref_name }}-manifest.json)
          \`\`\`" \
            /tmp/out/tinfoil-inference-${{ github.ref_name }}-manifest.json \
            /tmp/out/tinfoil-inference-${{ github.ref_name }}-checksums.sha256

      - name: Trigger config repo updates
        if: steps.check-prerelease.outputs.is_prerelease == 'false'
        run: |
          # Strip 'v' prefix for version
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"

          # Trigger the update workflow
          gh workflow run update-config-repos.yml --field version="$VERSION"
        env:
          GH_TOKEN: ${{ github.token }}
