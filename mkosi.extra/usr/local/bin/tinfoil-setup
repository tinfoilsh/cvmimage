#!/usr/bin/env python3

import os
import subprocess
import yaml

CONTAINERD_HOSTS_DIR = "/etc/containerd/certs.d"

def extract_image_from_args(args):
    """Extract image reference from args (last arg with '/' not starting with '-' or '/')."""
    for arg in reversed(args or []):
        if not arg.startswith("-") and "/" in arg and not arg.startswith("/"):
            return arg
    return ""

def normalize_image(image):
    """Add docker.io prefix for Docker Hub images (ctr requires full registry)."""
    if not image:
        return image
    parts = image.split("@")[0].split("/")
    if "." in parts[0] or ":" in parts[0] or parts[0] == "localhost":
        return image  # Already has registry
    return f"docker.io/{'library/' if len(parts) == 1 else ''}{image}"

def pull_image(image):
    """Pull image via containerd to use registry mirror."""
    print(f"Pulling {image} via containerd...")
    result = subprocess.run(
        ["ctr", "-n", "moby", "image", "pull", "--hosts-dir", CONTAINERD_HOSTS_DIR, image],
        capture_output=True, text=True
    )
    if result.returncode != 0:
        print(f"Pull failed: {result.stderr}")
    return result.returncode == 0

with open("/mnt/ramdisk/config.yml", "r") as f:
    config = yaml.safe_load(f)

if not config:
    print("Config empty")
    exit(1)

for model in config.get("models", []):
    os.system(f"modelpack-mount {model['mpk']}")

for container in config.get("containers", []):
    image = container.get("image", "")
    args = container.get("args", [])
    if isinstance(args, str):
        args = [args]
    
    # Extract and pull image (normalized for ctr)
    pull_img = image or extract_image_from_args(args)
    if pull_img:
        pull_image(normalize_image(pull_img))
    
    # Run container (original args unchanged)
    cmd = ["docker", "run", "-d", "--name", container["name"], "--network", "host", "-v", "/mnt/ramdisk:/tinfoil"]
    cmd.extend(args)
    if image:
        cmd.append(image)
    os.system(" ".join(cmd))
